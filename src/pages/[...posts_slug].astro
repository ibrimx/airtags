---
import type { CollectionEntry } from "astro:content"
import { getCollection, render } from "astro:content"

import Layout from "@/layouts/Layout.astro"
import TOC from "@/components/Widgets/TOC.astro"

import { getPosts } from "@/lib/notion/posts"
import { getPostBlocks } from "@/lib/notion/blocks"
import { BlockRenderer } from "@/components/notion/BlockRenderer"
import { getSiteConfig } from "@/lib/notion/site-config"

/* ========= STATIC PATHS ========= */

export async function getStaticPaths() {
  const markdownPosts = await getCollection("posts")
  const notionPosts = await getPosts(false)

  const paths: any[] = []

  markdownPosts.forEach((post) => {
    if (!post.data.draft) {
      paths.push({
        params: { posts_slug: `posts/${post.id}/` },
        props: { source: "markdown", post },
      })
    }
  })

  notionPosts.forEach((post) => {
    paths.push({
      params: { posts_slug: `posts/${post.slug}/` },
      props: { source: "notion", slug: post.slug },
    })
  })

  return paths
}

/* ========= RUNTIME ========= */

const { source } = Astro.props
const siteConfig = await getSiteConfig()

let post: any
let Content: any
let headings: any[] = []
let blocks: any[] = []

if (source === "markdown") {
  post = Astro.props.post
  const rendered = await render(post)
  Content = rendered.Content
  headings = rendered.headings
}

if (source === "notion") {
  const slug = Astro.params.posts_slug?.split("/").filter(Boolean).pop()
  const notionPosts = await getPosts(false)

  post = notionPosts.find(p => p.slug === slug)
  if (!post) throw new Error("Post not found")

  blocks = await getPostBlocks(post.id)
}

/* ========= NORMALIZE ========= */

const title = post?.data?.title ?? post?.title
const description =
  post?.data?.description ?? post?.excerpt ?? ""
const cover = post?.data?.cover ?? post?.cover
const publishDate =
  post?.data?.published ?? post?.publishDate
const contentType =
  post?.data?.contentType ?? post?.contentType ?? "essay"
const tags = post?.data?.tags ?? post?.tags ?? []

const layoutClass = `post-${contentType}`

const seoTitle = `${title} | ${siteConfig.siteName}`
---

<Layout postTitle={seoTitle} postDescription={description}>

  <article class={`post-page ${layoutClass}`}>

    {cover && (
      <section class="post-hero">
        <img src={cover} alt={title} />
      </section>
    )}

    <h1>{title}</h1>

    {publishDate && (
      <time datetime={publishDate}>
        {new Date(publishDate).toLocaleDateString()}
      </time>
    )}

    {source === "markdown" && headings?.length > 0 && (
      <TOC headings={headings} />
    )}

    <section class="post-content">
      {source === "markdown" && <Content />}
      {source === "notion" && <BlockRenderer blocks={blocks} />}
    </section>

    {tags.length > 0 && (
      <ul class="post-tags">
        {tags.map((tag: string) => (
          <li>#{tag}</li>
        ))}
      </ul>
    )}

  </article>

</Layout>

<style>
.post-page {
  margin: 0 auto;
  padding: 3rem 0;
}

.post-journal .post-content {
  max-width: 680px;
  margin: 0 auto;
}

.post-project .post-content {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 2rem;
}

.post-experiment .post-content {
  border-left: 4px solid #333;
  padding-left: 2rem;
}
</style>
