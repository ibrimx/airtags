---
import { getCollection, render } from "astro:content"

import Layout from "@/layouts/Layout.astro"
import TOC from "@/components/Widgets/TOC.astro"

import { getPosts } from "@/lib/notion/posts"
import { getBlocksRecursive } from "@/lib/notion/blocks"
import { BlockRenderer } from "@/components/notion/BlockRenderer"
import { getSiteConfig } from "@/lib/notion/site-config"

/* ============================
   STATIC PATHS
============================ */

export async function getStaticPaths() {
  const paths: any[] = []

  const markdownPosts = await getCollection("posts")

  markdownPosts.forEach((post) => {
    if (!post.data.draft) {
      const slug = post.data.abbrlink || post.id
      paths.push({
        params: { posts_slug: `posts/${slug}/` },
        props: { source: "markdown", slug },
      })
    }
  })

  try {
    const notionPosts = await getPosts(false)

    notionPosts.forEach((post) => {
      paths.push({
        params: { posts_slug: `posts/${post.slug}/` },
        props: { source: "notion", slug: post.slug },
      })
    })
  } catch {}

  return paths
}

/* ============================
   RUNTIME
============================ */

const { source, slug } = Astro.props
const siteConfig = await getSiteConfig()

const previewSecret = import.meta.env.PREVIEW_SECRET
const preview =
  Astro.url.searchParams.get("preview") === previewSecret

const siteUrl = Astro.url.origin

let title = ""
let description = ""
let cover = ""
let publishDate: string | Date | undefined
let contentType = "essay"
let tags: string[] = []

let Content: any = null
let headings: any[] = []
let blocks: any[] = []

/* ========= MARKDOWN ========= */

if (source === "markdown") {
  const posts = await getCollection("posts")

  const post = posts.find((p) => {
    const s = p.data.abbrlink || p.id
    return s === slug
  })

  if (!post) throw new Error("Post not found")

  const rendered = await render(post)

  Content = rendered.Content
  headings = rendered.headings

  const data = post.data as any

  title = data.title
  description = data.description ?? ""
  cover = data.cover ?? ""
  publishDate = data.published
  contentType = data.contentType ?? "essay"
  tags = data.tags ?? []
}

/* ========= NOTION ========= */

if (source === "notion") {
  const notionPosts = await getPosts(preview)

  const post = notionPosts.find((p) => p.slug === slug)
  if (!post) throw new Error("Post not found")

  blocks = await getBlocksRecursive(post.id)

  title = post.title
  description = post.excerpt ?? ""
  cover = post.cover ?? ""
  publishDate = post.publishDate
  contentType = post.contentType ?? "essay"
  tags = post.tags ?? []
}

/* ============================
   SEO + STRUCTURED DATA
============================ */

const layoutClass = `post-${contentType}`
const seoTitle = `${title} | ${siteConfig.siteName}`
const url = `${siteUrl}/posts/${slug}/`
const ogImage = cover || siteConfig.ogImage

function generateSchema() {
  const base = {
    "@context": "https://schema.org",
    "@id": url,
    headline: title,
    description,
    image: ogImage,
    datePublished:
      publishDate instanceof Date
        ? publishDate.toISOString()
        : publishDate,
    dateModified:
      publishDate instanceof Date
        ? publishDate.toISOString()
        : publishDate,
    author: {
      "@type": "Person",
      name: siteConfig.siteName,
      url: siteUrl,
    },
    publisher: {
      "@type": "Organization",
      name: siteConfig.siteName,
      logo: {
        "@type": "ImageObject",
        url: siteConfig.ogImage,
      },
    },
    mainEntityOfPage: {
      "@type": "WebPage",
      "@id": url,
    },
  }

  if (contentType === "project")
    return { ...base, "@type": "CreativeWork" }

  if (contentType === "experiment")
    return { ...base, "@type": "TechArticle" }

  if (contentType === "journal")
    return { ...base, "@type": "BlogPosting" }

  return { ...base, "@type": "Article" }
}

const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    {
      "@type": "ListItem",
      position: 1,
      name: "Home",
      item: siteUrl,
    },
    {
      "@type": "ListItem",
      position: 2,
      name: "Posts",
      item: `${siteUrl}/posts/`,
    },
    {
      "@type": "ListItem",
      position: 3,
      name: title,
      item: url,
    },
  ],
}
---

<Layout
  postTitle={seoTitle}
  postDescription={description}
  postImage={ogImage}
  postSlug={slug}
>

  <script type="application/ld+json" is:inline>
    {JSON.stringify(generateSchema())}
  </script>

  <script type="application/ld+json" is:inline>
    {JSON.stringify(breadcrumbSchema)}
  </script>

  <article class={`post-page ${layoutClass}`}>

    {cover && (
      <section class="post-hero">
        <img src={cover} alt={title} />
      </section>
    )}

    <h1>{title}</h1>

    {publishDate && (
      <time datetime={
        publishDate instanceof Date
          ? publishDate.toISOString()
          : publishDate
      }>
        {new Date(publishDate).toLocaleDateString()}
      </time>
    )}

    {source === "markdown" && headings?.length > 0 && (
      <TOC headings={headings} />
    )}

    <section class="post-content">
      {source === "markdown" && <Content />}
      {source === "notion" && (
        <BlockRenderer blocks={blocks} />
      )}
    </section>

    {tags.length > 0 && (
      <ul class="post-tags">
        {tags.map((tag) => (
          <li>#{tag}</li>
        ))}
      </ul>
    )}

  </article>

</Layout>
