---
import { getCollection, render } from "astro:content"

import Layout from "@/layouts/Layout.astro"
import TOC from "@/components/Widgets/TOC.astro"

import { getPosts } from "@/lib/notion/posts"
import { getBlocksRecursive } from "@/lib/notion/blocks"
import { BlockRenderer } from "@/components/notion/BlockRenderer"
import { getSiteConfig } from "@/lib/notion/site-config"

/* ============================
   STATIC PATHS
============================ */

export async function getStaticPaths() {
  const paths: any[] = []

  const markdownPosts = await getCollection("posts")

  markdownPosts.forEach((post) => {
    if (!post.data.draft) {
      const slug = post.data.abbrlink || post.id
      paths.push({
        params: { posts_slug: `posts/${slug}/` },
        props: { source: "markdown" },
      })
    }
  })

  try {
    const notionPosts = await getPosts(false)

    notionPosts.forEach((post) => {
      paths.push({
        params: { posts_slug: `posts/${post.slug}/` },
        props: { source: "notion" },
      })
    })
  } catch {}

  return paths
}

/* ============================
   RUNTIME
============================ */

const { source } = Astro.props
const siteConfig = await getSiteConfig()

const slug = Astro.params.posts_slug
  ?.split("/")
  .filter(Boolean)
  .pop()
  ?.toLowerCase()

const previewSecret = import.meta.env.PREVIEW_SECRET
const preview =
  Astro.url.searchParams.get("preview") === previewSecret

const siteUrl = Astro.url.origin

let title = ""
let description = ""
let cover = ""
let publishDate: string | Date | undefined
let contentType = "essay"
let tags: string[] = []

let Content: any = null
let headings: any[] = []
let blocks: any[] = []

/* ========= MARKDOWN ========= */

if (source === "markdown") {
  const posts = await getCollection("posts")

  const post = posts.find((p) => {
    const s = (p.data.abbrlink || p.id).toLowerCase()
    return s === slug
  })

  if (!post) throw new Error("Post not found")

  const rendered = await render(post)

  Content = rendered.Content
  headings = rendered.headings

  const data = post.data as any

  title = data.title
  description = data.description ?? ""
  cover = data.cover ?? ""
  publishDate = data.published
  contentType = data.contentType ?? "essay"
  tags = data.tags ?? []
}

/* ========= NOTION ========= */

if (source === "notion") {
  const notionPosts = await getPosts(preview)

  const post = notionPosts.find(
    (p) => p.slug?.toLowerCase() === slug
  )

  if (!post) throw new Error("Post not found")

  blocks = await getBlocksRecursive(post.id)

  title = post.title
  description = post.excerpt ?? ""
  cover = post.cover ?? ""
  publishDate = post.publishDate
  contentType = post.contentType ?? "essay"
  tags = post.tags ?? []
}

/* ============================
   SEO
============================ */

const layoutClass = `post-${contentType}`
const seoTitle = `${title} | ${siteConfig.siteName}`
const ogImage = cover || siteConfig.ogImage

function normalizeDate(d: any) {
  if (!d) return undefined
  return d instanceof Date ? d.toISOString() : d
}
---

<Layout
  postTitle={seoTitle}
  postDescription={description}
  postImage={ogImage}
  postSlug={`/posts/${slug}/`}
>

  <article class={`heti post-page ${layoutClass}`}>

    {cover && (
      <section class="post-hero">
        <img src={cover} alt={title} />
      </section>
    )}

    <h1 class="post-title">{title}</h1>

    {publishDate && (
      <time datetime={normalizeDate(publishDate)}>
        {new Date(publishDate).toLocaleDateString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
        })}
      </time>
    )}

    {source === "markdown" && headings?.length > 0 && (
      <TOC headings={headings} />
    )}

    <section class="post-content">
      {source === "markdown" && <Content />}

      {source === "notion" && (
        <BlockRenderer
          blocks={blocks}
          client:only="react"
        />
      )}
    </section>

    {tags.length > 0 && (
      <ul class="post-tags">
        {tags.map((tag) => (
          <li>#{tag}</li>
        ))}
      </ul>
    )}

  </article>

</Layout>

<style>
.post-page {
  padding: 4rem 1.2rem;
}

.post-title {
  margin-bottom: 1rem;
}
</style>
