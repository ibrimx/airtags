---
interface NotionAnnotations {
  bold: boolean
  italic: boolean
  strikethrough: boolean
  underline: boolean
  code: boolean
  color: string
}

interface NotionRichText {
  plain_text: string
  href?: string | null
  annotations?: NotionAnnotations
}

interface NotionBlock {
  type: string
  has_children?: boolean
  children?: NotionBlock[]
  [key: string]: any
}

const props = Astro.props as { blocks?: NotionBlock[] }
const blocks: NotionBlock[] = props.blocks ?? []

// ========================================
// âœ… Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© - Ø­Ø·Ù‘Ù‡Ù… Ù‡Ù†Ø§ Ø¨Ø§Ù„Ø¶Ø¨Ø·
// ========================================

function escapeHtml(str: string): string {
  return str
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
}

function richText(rich?: NotionRichText[]): string {
  if (!rich || rich.length === 0) return ""

  return rich.map((t) => {
    let html = escapeHtml(t.plain_text)

    if (t.annotations?.code) {
      html = `<code>${html}</code>`
    }
    if (t.annotations?.bold) {
      html = `<strong>${html}</strong>`
    }
    if (t.annotations?.italic) {
      html = `<em>${html}</em>`
    }
    if (t.annotations?.strikethrough) {
      html = `<s>${html}</s>`
    }
    if (t.annotations?.underline) {
      html = `<u>${html}</u>`
    }
    if (t.annotations?.color && t.annotations.color !== "default") {
      const color = t.annotations.color
      if (color.endsWith("_background")) {
        html = `<span style="background:var(--notion-${color})">${html}</span>`
      } else {
        html = `<span style="color:var(--notion-${color})">${html}</span>`
      }
    }
    if (t.href) {
      html = `<a href="${t.href}" target="_blank" rel="noopener">${html}</a>`
    }

    return html
  }).join("")
}

function plainText(rich?: NotionRichText[]): string {
  if (!rich) return ""
  return rich.map((t) => t.plain_text).join("")
}

// âœ… ØªØ¬Ù…ÙŠØ¹ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…ØªØªØ§Ù„ÙŠØ©
function groupBlocks(blocks: NotionBlock[]): (NotionBlock | NotionBlock[])[] {
  const grouped: (NotionBlock | NotionBlock[])[] = []
  let i = 0

  while (i < blocks.length) {
    const block = blocks[i]

    if (block.type === "bulleted_list_item") {
      const items: NotionBlock[] = []
      while (i < blocks.length && blocks[i].type === "bulleted_list_item") {
        items.push(blocks[i])
        i++
      }
      grouped.push(items)
    } else if (block.type === "numbered_list_item") {
      const items: NotionBlock[] = []
      while (i < blocks.length && blocks[i].type === "numbered_list_item") {
        items.push(blocks[i])
        i++
      }
      grouped.push(items)
    } else {
      grouped.push(block)
      i++
    }
  }

  return grouped
}

const groupedBlocks = groupBlocks(blocks)
---

{/* âœ… Ù‡Ù†Ø§ ÙŠØ¨Ø¯Ø£ Ø§Ù„Ù€ HTML template */}

{groupedBlocks.map((item) => {

  if (Array.isArray(item) && item[0]?.type === "bulleted_list_item") {
    return (
      <ul>
        {item.map((block) => (
          <li>
            <Fragment set:html={richText(block.bulleted_list_item?.rich_text)} />
            {block.children && <Astro.self blocks={block.children} />}
          </li>
        ))}
      </ul>
    )
  }

  if (Array.isArray(item) && item[0]?.type === "numbered_list_item") {
    return (
      <ol>
        {item.map((block) => (
          <li>
            <Fragment set:html={richText(block.numbered_list_item?.rich_text)} />
            {block.children && <Astro.self blocks={block.children} />}
          </li>
        ))}
      </ol>
    )
  }

  const block = item as NotionBlock

  if (block.type === "paragraph") {
    const content = richText(block.paragraph?.rich_text)
    if (!content) return <br />
    return <p set:html={content} />
  }

  if (block.type === "heading_1") {
    return <h1 set:html={richText(block.heading_1?.rich_text)} />
  }

  if (block.type === "heading_2") {
    return <h2 set:html={richText(block.heading_2?.rich_text)} />
  }

  if (block.type === "heading_3") {
    return <h3 set:html={richText(block.heading_3?.rich_text)} />
  }

  if (block.type === "quote") {
    return <blockquote set:html={richText(block.quote?.rich_text)} />
  }

  if (block.type === "callout") {
    const icon = block.callout?.icon?.emoji || "ðŸ’¡"
    return (
      <div class="notion-callout">
        <span class="callout-icon">{icon}</span>
        <div class="callout-content" set:html={richText(block.callout?.rich_text)} />
      </div>
    )
  }

  if (block.type === "toggle") {
    return (
      <details>
        <summary set:html={richText(block.toggle?.rich_text)} />
        {block.children && <Astro.self blocks={block.children} />}
      </details>
    )
  }

  if (block.type === "code") {
    const lang = block.code?.language || ""
    return (
      <pre class={`language-${lang}`}>
        <code>{plainText(block.code?.rich_text)}</code>
      </pre>
    )
  }

  if (block.type === "image") {
    const src = block.image?.file?.url || block.image?.external?.url
    if (!src) return null
    return (
      <figure class="notion-image">
        <img src={src} alt="" loading="lazy" />
        {block.image?.caption?.length > 0 && (
          <figcaption>{plainText(block.image.caption)}</figcaption>
        )}
      </figure>
    )
  }

  if (block.type === "video") {
    const src = block.video?.file?.url || block.video?.external?.url
    if (!src) return null
    return (
      <figure class="notion-video">
        <video controls preload="metadata">
          <source src={src} />
        </video>
      </figure>
    )
  }

  if (block.type === "divider") {
    return <hr />
  }

  if (block.type === "table") {
    return (
      <div class="table-wrapper">
        <table>
          <tbody>
            {block.children?.map((row: NotionBlock, i: number) => (
              <tr>
                {row.table_row?.cells?.map((cell: NotionRichText[]) => {
                  const Tag = i === 0 && block.table?.has_column_header ? "th" : "td"
                  return <Tag set:html={richText(cell)} />
                })}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    )
  }

  if (block.type === "column_list") {
    return (
      <div class="notion-columns">
        {block.children?.map((col: NotionBlock) => (
          <div class="notion-column">
            <Astro.self blocks={col.children ?? []} />
          </div>
        ))}
      </div>
    )
  }

  if (block.type === "bookmark") {
    const url = block.bookmark?.url
    if (!url) return null
    return (
      <a class="notion-bookmark" href={url} target="_blank" rel="noopener">
        {url}
      </a>
    )
  }

  return null
})}
